<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brohood</title>

    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    
</head>
<style>
body {
    margin: 0;
    padding: 0;
    font-family:serif;
    height: 100vh;
    background: linear-gradient(180deg, #f0f0f0, #a28089);

}
.logo {
    width: 32px;
    height: 32px;
    padding: 20px;
}

nav{
    width:100vw;
}

.nav__container{
    display:flex;
    justify-content: space-between;
    align-items: center;
}


.nav__menu{ 
    display: flex;
    align-items: center;
    gap: 6rem;
    margin-right: 200px;
}
.nav__menu a{
    font-size: 0.9rem;
    transition: all 400ms ease;
    text-decoration: none;
    color: #2c2a2a;
    
}
.nav__menu a:hover{
    color: #942542;
}

h0{
    font-size: 18px;
    font-weight: bold;
}

.main-text {
    font-family: 'Brush Script MT', cursive;
    font-size: 50px;
    margin-left: 30px;
}
.main-text a {
    color: #8b5d6a; 
    text-decoration: none; 
}
.model .shirt {
    width: 350px;
    height: 350px;
    margin-left: 300px;
    margin-top: -50px;
}
.option {
    display: flex;
    flex-direction: column;
    padding: 50px;
    margin-top: -350px;
    margin-left: 1100px;
    position: relative;
}
.option-container {
    position: relative;
    margin-bottom: 20px;
}
.img1, .img2, .img3 {
    width: 50px;
    height: 50px;
    padding: 10px;
    cursor: pointer;
    object-fit: cover; 
}
.text {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    color: rgb(146, 10, 10);
    text-align: center;
    font-size: 18px;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.option-container:hover .text {
    opacity: 1;
}
.color-picker {
    display: none;
}
.upload-section {
    display: none;
    flex-direction: column;
    margin-top: -100px;
    margin-left: -300px;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
    background: #ffffff50;
    
    position: absolute;
}

#resetButton {
    margin-top: 10px;
    padding: 5px 10px;
    font-size: 14px;
    color: #fff;
    background-color: #8b5d6a;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

#resetButton:hover {
    background-color: #6a444e;
}

textarea {
   resize: none;
   height: 100px;
    color: rgb(46, 26, 26);
    background-color:transparent ;
    border: 1px solid #6a444e;
}
textarea:focus {
    border-color: rgb(80, 35, 65);
    outline: none;
}

textarea::placeholder{
    color: rgb(56, 45, 45);
    font-family:serif;
    
}
.ai-section {
    display: none;
    flex-direction: column;
    margin-top: -100px;
    margin-left: -200px;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
    background: #ffffff50;
    position: absolute;
}
.ai-section h1{
    color: rgb(80, 35, 65);
    margin-top: -5px;
}
#generateButton{
    cursor: pointer;
    background-color:#6a444e;
    border: 1px solid transparent;
    color: #fff;
}

.button-container {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.button-container button {
    padding: 5px 10px;
    font-size: 14px;
    color: #fff;
    background-color: #8b5d6a;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.button-container button:hover {
    background-color: #6a444e;
}
.image1 {
 
   display:none;


}
.click{
    margin-top: 30px;
    display: flex; 
    flex-wrap: wrap;
    gap: 15px;
}
#saveButton, #downloadButton, #cart-btn,#wishlist-btn {
    padding: 5px 10px;
    font-size: 14px;
    border: 2px solid #333;
    background-color: #333;
    color: white;
    border-radius: 25px;
    cursor: pointer;
    margin-left: 20px;
    transition: all 0.3s ease;
}

    /* #cart-btn, #wishlist-btn{
        display: none;
    } */
.data {
    margin-left: 800px;
    margin-top: -30px;
}
#saveButton:hover, #downloadButton:hover,#cart-btn:hover,#wishlist-btn:hover {
   background-color: white;
    color: #333;
     transition: background-color 0.3s ease, color 0.3s ease;
}
#fileresetButton {
    margin-top: 10px;
    padding: 5px 10px;
    font-size: 14px;
    color: #fff;
    background-color: #8b5d6a;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

#fileresetButton:hover {
    background-color: #6a444e;
}

#colorresetButton {
    margin-top: 10px;
    padding: 5px 10px;
    font-size: 14px;
    color: #fff;
    background-color: #8b5d6a;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

#colorresetButton:hover {
    background-color: #6a444e;
}

</style>
<body>
    
    <section class="container">
        <nav>
            <div class="container nav__container">
                <img src="./images/threejs.png" alt="logo" class="logo" >
                <ul class="nav__menu">
                    <a href="main.html"><h0>Home</h0></a>
                    <a href="products.html"><h0>Products</h0></a>
                    <a href="MyCart.html"><h0>MyCart</h0></a>
                    <a href="#" id="profile-link"><h0>Profile</h0></a>
                </ul>
            </div>
        </nav>
        <div class="main-text">
          <a href="/index.html">BRO <br/>HOOD</a>  
        </div>
        <!-- auto-rotate camera-controls -->
        <div class="model">
            <model-viewer id="shirtModel" src="./images/oversized_t-shirt.glb" alt="3D Shirt" rotate camera-controls class="shirt" experimental-scene-graph>
            </model-viewer>
        </div>

        <div class="option">
            <div class="option-container">
                <img src="./images/swatch.png" class="img1" onclick="openColorPicker()">
                <!-- <div class="text">color</div> -->
                    <input type="color"  id="colorInput" class="color-picker" value="#ffffff">
                    <button id="colorresetButton" onclick="resetModelColor()">Reset</button>
            </div>

            <div class="option-container">
                <img src="./images/file.png" class="img2" onclick="toggleUploadSection()">
                <div class="text">files</div>

                <div class="upload-section" id="uploadSection">
                    <h2>Upload Your Image</h2>
                    <label for="file-input" class="file-label">Choose Image</label>
                    <input type="file" id="file-input" class="file-input" accept="image/*">
                    <div class="button-container">
                        <button onclick="applyImageToBack()">Apply to Back</button>

                        <button onclick="applyImageToFullShirt()">Apply to Full Shirt</button>
                    </div>
                    <button id="fileresetButton" onclick="resetModelfile()">Reset</button>
                </div>
            </div>

            <div class="option-container">
                <img src="./images/ai.png" class="img3" onclick="toggleAISection()">
                <div class="text">ai</div>
                <div class="ai-section" id="aiSection">
                    <h1>Ask AI</h1>
                    <textarea  id="generator-positive" name="message" placeholder="Type your T-shirt design description here" required></textarea>
                    <button  id="generateButton" onclick="generateDesignFromText()">Generate Design</button>
                    <div class="image1">
                        <img id="image-display" src="./images/images.jpeg" alt="AI Generated Design" >
                      </div>
                 
                </div>
            </div>

            <button id="resetButton" onclick="resetModelColor()">Reset</button>
        </div>
        <div class="click">
        <button id="saveButton" onclick="saveModel()">Save Model</button>
        <button id="downloadButton" onclick="downloadModel()">Download Model</button>
        <div class="data" id="data" style="display: none;">
            <button id="cart-btn" onclick="addToCart()">Add to Cart</button>
            <button id="wishlist-btn">Wishlist</button>
        </div>
        </div>
    </section>

    <script>

        
        function openColorPicker() {
            document.getElementById('uploadSection').style.display = 'none';
    document.getElementById('aiSection').style.display = 'none';

    const colorInput = document.getElementById('colorInput');
    colorInput.click();
        }

        async function changeModelColor(event) {
            const modelViewer = document.getElementById('shirtModel');
            const hexColor = event.target.value;
            
            const r = parseInt(hexColor.slice(1, 3), 16) / 255;
            const g = parseInt(hexColor.slice(3, 5), 16) / 255;
            const b = parseInt(hexColor.slice(5), 16) / 255;

            await modelViewer.updateComplete;

            const material = modelViewer.model.materials[0];
            material.pbrMetallicRoughness.setBaseColorFactor([r, g, b, 1]);
        }

        document.getElementById('colorInput').addEventListener('input', changeModelColor);
        
    const colorInput = document.getElementById('colorInput');
    const colorResetButton = document.getElementById('colorresetButton');
    const shirtModel = document.getElementById('shirtModel');

    colorResetButton.style.display = 'none';

    colorInput.addEventListener('input', () => {
        const color = colorInput.value;
        shirtModel.style.setProperty('--base-color', color); 
        colorResetButton.style.display = 'block';
    });

    
    function resetModelColor() {
    const modelViewer = document.getElementById('shirtModel');
    const colorInput = document.getElementById('colorInput');
    const colorResetButton = document.getElementById('colorresetButton');

    // Reset the color input to white
    colorInput.value = '#ffffff';

    // Ensure the model is fully loaded before modifying materials
    modelViewer.updateComplete.then(() => {
        const material = modelViewer.model.materials[0];
        material.pbrMetallicRoughness.setBaseColorFactor([1, 1, 1, 1]); // White color
    });

    // Hide reset button
    colorResetButton.style.display = 'none';
}

function resetModelfile() {
    const modelViewer = document.getElementById('shirtModel');
    const fileInput = document.getElementById('file-input');
    const fileResetButton = document.getElementById('fileresetButton');

    // Clear file input
    fileInput.value = '';

    // Ensure the model is fully loaded before modifying materials
    modelViewer.updateComplete.then(() => {
        const material = modelViewer.model.materials[0];

        // Remove the texture by setting it to null
        material.pbrMetallicRoughness.baseColorTexture.setTexture(null);
    });

    // Hide reset button
    // fileResetButton.style.display = 'none';
}


        function toggleUploadSection() {
            const uploadSection = document.getElementById('uploadSection');
    const isCurrentlyVisible = uploadSection.style.display === 'flex';

    document.getElementById('aiSection').style.display = 'none';


    uploadSection.style.display = isCurrentlyVisible ? 'none' : 'flex';
            }

        async function addLogoToShirt(event) {
    const modelViewer = document.getElementById('shirtModel');
    const file = event.target.files[0];

    if (file) {
        const reader = new FileReader();

        reader.onload = async function (e) {
            const imageUrl = e.target.result;
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 1024; 
            canvas.height = 1024;

            context.clearRect(10, 10, canvas.width, canvas.height);
            const logoSize = 256; 
            const xPosition = (canvas.width - logoSize) / 4.5; 
            const yPosition = 270; 

            const logoImage = new Image();
            logoImage.src = imageUrl;

            logoImage.onload = async () => {
                context.save();
                context.translate(0, canvas.height);
                context.scale(1, -1);

                context.drawImage(logoImage, xPosition, canvas.height - yPosition - logoSize, logoSize, logoSize);

                context.restore();

                const textureUrl = canvas.toDataURL();

                await modelViewer.updateComplete;
                const texture = await modelViewer.createTexture(textureUrl);
                const material = modelViewer.model.materials[0];

                material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
            };
        };

        reader.readAsDataURL(file);
    }
}

document.getElementById('file-input').addEventListener('change', addLogoToShirt);

async function applyImageToBack() {
        const modelViewer = document.getElementById('shirtModel');
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];

        if (file) {
            const reader = new FileReader();

            reader.onload = async function (e) {
                const imageUrl = e.target.result;

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                canvas.width = 1024;
                canvas.height = 1024;

                context.clearRect(0, 0, canvas.width, canvas.height);

                const logoSize = 256; 
            const xPosition = (canvas.width *2) /3.25; 
            const yPosition = 270; 

                const logoImage = new Image();
                logoImage.src = imageUrl;

                logoImage.onload = async () => {
                    context.save();
                    context.translate(0, canvas.height);
                    context.scale(1, -1);
                    context.drawImage(
                        logoImage,
                        xPosition,
                        canvas.height - yPosition - logoSize,
                        logoSize,
                        logoSize
                    );
                    context.restore();

                    const textureUrl = canvas.toDataURL();
                    await modelViewer.updateComplete;

                    const texture = await modelViewer.createTexture(textureUrl);
                    const material = modelViewer.model.materials[0];

                    material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
                };
            };

            reader.readAsDataURL(file);
        } else {
            alert('Please select an image to apply.');
        }
    }

    async function applyImageToFullShirt() {
        const modelViewer = document.getElementById('shirtModel');
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];

        if (file) {
            const reader = new FileReader();

            reader.onload = async function (e) {
                const imageUrl = e.target.result;

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                canvas.width = 1024;
                canvas.height = 1024;

                context.clearRect(0, 0, canvas.width, canvas.height);

                const logoSize = 256; 
            const xPosition = (canvas.width -logoSize) /4.5; 
            const yPosition = 270; 

                const logoImage = new Image();
                logoImage.src = imageUrl;

                logoImage.onload = async () => {
                    context.save();
                    context.translate(0, canvas.height);
                    context.scale(1, -1);
                    context.drawImage(logoImage, 0,44, canvas.width, canvas.height);
                    context.restore();


                    const textureUrl = canvas.toDataURL();
                    await modelViewer.updateComplete;

                    const texture = await modelViewer.createTexture(textureUrl);
                    const material = modelViewer.model.materials[0];

                    material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
                };
            };

            reader.readAsDataURL(file);
        } else {
            alert('Please select an image to apply.');
        }
    }


function toggleAISection() {
    const aiSection = document.getElementById('aiSection');
    const isCurrentlyVisible = aiSection.style.display === 'flex';

    document.getElementById('uploadSection').style.display = 'none';

    aiSection.style.display = isCurrentlyVisible ? 'none' : 'flex';
    }

    const inputRef = document.getElementById('generator-positive');
    const generateBtn = document.getElementById('generateButton');
    const imageDisplay = document.getElementById('image-display');
    generateBtn.addEventListener('click', async () => {
    const prompt = inputRef.value;
    if (!prompt) return;

    const form = new FormData();
    form.append('prompt', prompt);

    try {
        const response = await fetch('https://clipdrop-api.co/text-to-image/v1', {
            method: 'POST',
            headers: {
                'x-api-key': 'deabe596b5e1193d22d90821cf07eac946076e27d5430bb4ca7b66cfd0d3a17b2ed227356abd3ab4d104724fe95ebfc3',
            },
            body: form,
        });

        const buffer = await response.arrayBuffer();
        const blob = new Blob([buffer], { type: 'image/jpeg' });
        const imageUrl = URL.createObjectURL(blob);

        imageDisplay.src = imageUrl;
        const modelViewer = document.getElementById('shirtModel');
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        canvas.width = 1024; 
        canvas.height = 1024;
        const logoSize = 256; 
            const xPosition = (canvas.width - logoSize) / 4.5; 
            const yPosition = 270; 

        const img = new Image();
        img.src = imageUrl;
        img.onload = async () => {
            context.save();
            context.translate(0, canvas.height);
            context.scale(1, -1); 
            
            context.drawImage(img, 0, 0, canvas.width, canvas.height);
            context.restore();

            const textureUrl = canvas.toDataURL();
            await modelViewer.updateComplete;

            const texture = await modelViewer.createTexture(textureUrl);
            const material = modelViewer.model.materials[0];
            material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
        };
    } catch (error) {
        console.error('Error generating or applying image:', error);
    }
});


function saveModel() {
    // Display the modal
    document.querySelector('.data').style.display = 'block';

    // Capture the modal (preview) image or 3D model
    const modalImage = document.querySelector('.data img')?.src || 'default.png'; // fallback if no image

    // Save to localStorage so "Add to Cart" can use it
    localStorage.setItem('savedTShirtModel', modalImage);
}
function addToCart() {
    const imageSrc = localStorage.getItem('savedTShirtModel') || 'default.png';
 
    const newItem = {
        name: "Designed T-Shirt",
        price: "10",  // in â‚¹
        quantity: 1,
        size: "M",
        image: imageSrc.split('/').pop()  // get only filename
    };

    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    cart.push(newItem);
    localStorage.setItem("cart", JSON.stringify(cart));

    alert("Item added to cart!");
}



function resetModel() {
    const modelViewer = document.getElementById('shirtModel');

    const defaultColor = [1, 1, 1, 1];
    modelViewer.model.materials[0].pbrMetallicRoughness.setBaseColorFactor(defaultColor);

    modelViewer.model.materials[0].pbrMetallicRoughness.baseColorTexture.setTexture(null);

    const imageDisplay = document.getElementById('image-display');
    imageDisplay.src = "";  
}

document.getElementById('resetButton').addEventListener('click', () => {
    resetModel();
    document.getElementById('colorInput').value = '#ffffff'; 
    document.getElementById('file-input').value = ''; 
});

function downloadModel() {
    const modelViewer = document.getElementById('shirtModel');
    
    modelViewer.exportScene({ binary: true }).then((glbData) => {
        const blob = new Blob([glbData], { type: 'model/gltf-binary' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'updated-shirt-model.glb'; 
        a.click();
        URL.revokeObjectURL(url);
    }).catch((error) => {
        console.error("Error downloading the model:", error);
    });
}
    


document.addEventListener("DOMContentLoaded", function () {
    const profileLink = document.getElementById("profile-link");
    const username = localStorage.getItem("username");

    if (username) {
        profileLink.innerHTML = `<h0>${username.split('@')[0]}</h0>`;
    }

    profileLink.addEventListener("click", function (event) {
        event.preventDefault();

        if (username) {
            window.location.href = "admin.html"; 
        }
    });
});

    
    </script>
</body>
</html>